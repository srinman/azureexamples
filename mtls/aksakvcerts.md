# Certificates with Azure Key vault


## Use case

Certificates are generated by a tool like Venafi or Hashicorp Vault and stored in Azure Key Vault. The certificates are used by applications running in Azure Kubernetes Service (AKS) or Azure App Service. The certificates are used for TLS termination in the application gateway or for mutual TLS between services. The certificates are also used for authentication to Azure services like Azure Container Registry (ACR) or Azure Service Bus. 

## Solution

The solution is to use the Azure Key Vault Secrets CSI driver to mount the certificates as files in the container. The certificates are stored in Azure Key Vault as secrets. The Azure Key Vault Secrets CSI driver mounts the secrets as files in the container. The application can then use the certificates as files.

## Prerequisites

* Azure subscription
* Azure CLI
* Azure Kubernetes Service (AKS)
* Azure Key Vault
* Azure Key Vault Secrets CSI driver

## Setup

### Create Azure Key Vault

Create an Azure Key Vault. The Azure Key Vault name must be globally unique. The Azure Key Vault name is used as the DNS name for the Azure Key Vault. The Azure Key Vault name must be between 3 and 24 characters in length. The Azure Key Vault name can contain only alphanumeric characters and dashes. The Azure Key Vault name must start with a letter. The Azure Key Vault name must end with a letter or a number.

```bash
az keyvault create \
    --name <azure-key-vault-name> \
    --resource-group <azure-resource-group-name> \
    --location <azure-region>
```

### Import certificate into Azure Key Vault

Import a certificate into Azure Key Vault. The certificate must be in PFX format. The certificate must be password protected. The certificate must be less than 25 KB in size. The certificate must be valid for at least 7 days. The certificate must be valid for at least 1 day longer than the certificate's validity period. The certificate must be valid for at least 1 day longer than the certificate's validity period. The certificate must be valid for at least 1 day longer than the certificate's validity period. The certificate must be valid for at least 1 day longer than the certificate's validity period. The certificate must be valid for at least 1 day longer than the certificate's validity period. The certificate must be valid for at least 1 day longer than the certificate's validity period.

```bash
az keyvault certificate import \
    --vault-name <azure-key-vault-name> \
    --name <azure-key-vault-certificate-name> \
    --file <certificate-file-path> \
    --password <certificate-password>




```

Following is an example of importing a certificate into Azure Key Vault. It uses PEM file. 

https://learn.microsoft.com/en-us/azure/key-vault/certificates/tutorial-import-certificate?tabs=azure-portal

```
az keyvault certificate import \
    --vault-name srinmanakvtest \
    --name certtest \
    --file client.pem \
    --password test
``` 

Once this is imported, it's stored in AKV.  

It's important to use this following command to get both the private key and the certificate. Note it references **secret** and not **certificate**. 


``` 

az keyvault secret download --file downloaded_test3.pem --name certtest --vault-name srinmanakvtest

```

In order to do this same operation in AKS, we need to use the CSI driver.  Native libraries can be used to do this, but it's recommended to use the CSI driver to keep your code portable.

az aks show -g rgname -n aksclustername  --query addonProfiles.azureKeyvaultSecretsProvider

Note down the client id (let's use uami-ssidriver to identify this in the subsequent sections/code) and the tenant id. 

export KEYVAULT_SCOPE=$(az keyvault show --name srinmanakvtest --query id -o tsv)

Feel free to limit the role to only read.

az role assignment create --role "Key Vault Administrator" --assignee uami-ssidriver --scope $KEYVAULT_SCOPE


In the following example, we are using the CSI driver to mount the certificate as a file in the container. The certificate is stored in Azure Key Vault as a secret. It's important to note that **secret** object type is used.  


```yaml
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-kvname-user-msi
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"          # Set to true for using managed identity
    userAssignedIdentityID: "uami-ssidriver"  #CHANGE THIS
    keyvaultName: srinmanakvtest        # Set to the name of your key vault
    cloudName: ""                         # [OPTIONAL for Azure] if not provided, the Azure environment defaults to AzurePublicCloud
    objects:  |
      array:
        - |
          objectName: certtest
          objectType: secret              # object types: secret, key, or cert
          objectVersion: ""               # [OPTIONAL] object versions, default to latest if empty
    tenantId: "xyz"                #CHANGE THIS The tenant ID of the key vault
```




```yaml
# This is a sample pod definition for using SecretProviderClass and the user-assigned identity to access your key vault
kind: Pod
apiVersion: v1
metadata:
  name: busybox-secrets-store-inline-user-msi
spec:
  containers:
    - name: busybox
      image: registry.k8s.io/e2e-test-images/busybox:1.29-4
      command:
        - "/bin/sleep"
        - "10000"
      volumeMounts:
      - name: secrets-store01-inline
        mountPath: "/mnt/secrets-store"
        readOnly: true
  volumes:
    - name: secrets-store01-inline
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: "azure-kvname-user-msi"
```


k exec busybox-secrets-store-inline-user-msi -it -- sh -c 'cat /mnt/secrets-store/certtest'  
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCmJLd0jLfimFCC
....
3shB8hSYptGUMkjIwITD9xQ=
-----END PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
MIIDOTCCAiECFC6bDGfQvb2Fve2XuJFOQMJtPlPaMA0GCSqGSIb3DQEBCwUAMFkx
...
ngfilNx7jK5BYQpXv2qW5bDcI7Y27UXN2tGH3l9iKvgrX9KEF63RG2UW8L+g2kBP
QTHu0oT7MsNDYhbHPw==
-----END CERTIFICATE-----